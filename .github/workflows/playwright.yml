name: Playwright API Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    # No need for local MongoDB service since we're using Atlas
    steps:
    # 1️⃣ Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # 3️⃣ Install backend dependencies
    - name: Install backend dependencies
      run: |
        cd backend
        npm ci

    # 4️⃣ Install test dependencies and Playwright
    - name: Install test dependencies
      run: |
        cd tests
        npm ci
        npx playwright install --with-deps

    # 5️⃣ Start backend server with Atlas connection
    - name: Start backend server
      env:
        MONGODB_URI: ${{ secrets.MONGODB_ATLAS_URI }}
      run: |
        cd backend
        npm start &
        echo "Backend server starting with MongoDB Atlas..."
        
        # Wait for server to be ready
        sleep 15
        
        # Check if server is running
        if curl -f http://localhost:3001 > /dev/null 2>&1; then
          echo "✅ Server is running on port 3001"
        else
          echo "⚠️  Checking alternative ports..."
          curl -f http://localhost:3000 > /dev/null 2>&1 && echo "✅ Server running on port 3000" || echo "❌ Server not responding"
        fi

    # 6️⃣ Run Playwright tests
    - name: Run Playwright tests
      env:
        MONGODB_URI: ${{ secrets.MONGODB_ATLAS_URI }}
      run: |
        cd tests
        npx playwright test api/ --reporter=html,line

    # 7️⃣ Upload Playwright report
    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: tests/playwright-report/
        retention-days: 5